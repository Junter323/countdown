<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å€’æ•¸æ§åˆ¶ä¸­å¿ƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body { background: #f5f5f5; }
    .status-text { font-size: 0.75rem; color: #6c757d; }
    #token-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #token-box {
      background: #fff;
      padding: 20px 24px;
      border-radius: 8px;
      width: min(340px, 90vw);
      box-shadow: 0 4px 16px rgba(0,0,0,.2);
    }
    @media (max-width: 576px) {
      .control-header {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }
      .control-header .form-control {
        width: 100%;
      }
      .control-header .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- token è¼¸å…¥ -->
  <div id="token-overlay">
    <div id="token-box">
      <h5 class="mb-3">è«‹è¼¸å…¥æ§åˆ¶ token</h5>
      <input id="token-input" type="password" class="form-control mb-3" placeholder="è«‹è¼¸å…¥ token" />
      <div class="d-grid gap-2">
        <button id="token-submit" class="btn btn-primary">é€²å…¥æ§åˆ¶å°</button>
      </div>
      <div id="token-error" class="text-danger mt-2" style="display:none;">token ç„¡æ•ˆï¼Œè«‹å†è©¦ä¸€æ¬¡</div>
    </div>
  </div>

  <!-- æ§åˆ¶ç•«é¢ -->
  <div class="container py-4" id="control-ui" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3 gap-2 control-header">
      <h1 class="mb-0">å€’æ•¸æ§åˆ¶ä¸­å¿ƒ</h1>
      <div class="d-flex gap-2 flex-wrap" style="min-width:200px;">
        <input id="newId" type="text" class="form-control" placeholder="è¼¸å…¥å€’æ•¸ IDï¼Œä¾‹å¦‚ show-1" />
        <button id="addBtn" class="btn btn-primary">æ–°å¢å€’æ•¸å¡ç‰‡</button>
      </div>
    </div>

    <div id="cards" class="row g-3"></div>
  </div>

  <script>
    // ğŸ‘‡ é€™ä¸€è¡Œæ›æˆä½  Cloudflare Worker çš„ç¶²å€
    // ä¾‹å¦‚ const API_BASE = "https://countdown-api.junter323.workers.dev";
    const API_BASE = "https://countdown-api.cometw1234.workers.dev/";

    const CHECK_ROOM = "__check__";

    const cardsEl = document.getElementById('cards');
    const addBtn = document.getElementById('addBtn');
    const newIdInput = document.getElementById('newId');

    const overlay = document.getElementById('token-overlay');
    const controlUI = document.getElementById('control-ui');
    const tokenInput = document.getElementById('token-input');
    const tokenSubmit = document.getElementById('token-submit');
    const tokenError = document.getElementById('token-error');

    // æŠŠ token å­˜åœ¨ sessionStorage å°±ä¸ç”¨ä¸€ç›´æ‰“
    let CONTROL_TOKEN = sessionStorage.getItem('countdown_token') || '';

    const SAVED_KEY = 'countdown_rooms';
    function getSavedRooms() {
      try {
        return JSON.parse(localStorage.getItem(SAVED_KEY)) || [];
      } catch (e) {
        return [];
      }
    }
    function saveRooms(list) {
      localStorage.setItem(SAVED_KEY, JSON.stringify(list));
    }

    // ç™»å…¥ + è¼‰å…¥æˆ¿é–“
    async function tryEnter() {
      const t = tokenInput.value.trim();
      if (!t) return;

      // å…ˆé©— token
      const res = await fetch(`${API_BASE}/api`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ room: CHECK_ROOM, action: 'reset', token: t })
      });
      if (res.status === 401) {
        tokenError.style.display = 'block';
        return;
      }

      CONTROL_TOKEN = t;
      sessionStorage.setItem('countdown_token', t);
      overlay.style.display = 'none';
      controlUI.style.display = '';

      // å¾å¾Œç«¯æ‹¿ç¾æœ‰æˆ¿é–“
      let serverRooms = [];
      try {
        const r2 = await fetch(`${API_BASE}/api?rooms=1`);
        if (r2.ok) {
          const data = await r2.json();
          serverRooms = (data.rooms || []).filter(r => r !== CHECK_ROOM);
        }
      } catch (e) {}

      // å†åŠ ä¸Šæœ¬æ©Ÿå­˜çš„
      const localRooms = getSavedRooms().filter(r => r !== CHECK_ROOM);
      const allRooms = Array.from(new Set([...serverRooms, ...localRooms]));

      if (allRooms.length === 0) {
        createCard('show-1');
        saveRooms(['show-1']);
      } else {
        allRooms.forEach(r => createCard(r));
        saveRooms(allRooms);
      }
    }

    tokenSubmit.onclick = tryEnter;
    tokenInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') tryEnter();
    });

    // æœ‰å­˜é token çš„è©±è‡ªå‹•ç™»å…¥
    (async () => {
      if (CONTROL_TOKEN) {
        tokenInput.value = CONTROL_TOKEN;
        await tryEnter();
      }
    })();

    // æ–°å¢å¡ç‰‡
    if (addBtn) {
      addBtn.onclick = () => {
        const id = newIdInput.value.trim();
        if (!id) return;
        createCard(id);
        const cur = getSavedRooms();
        if (!cur.includes(id)) {
          cur.push(id);
          saveRooms(cur);
        }
        newIdInput.value = '';
      };
    }

    // å»ºç«‹å¡ç‰‡
    function createCard(roomId) {
      if (roomId === CHECK_ROOM) return;
      if (document.getElementById('card-' + roomId)) return;

      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';
      col.id = 'card-' + roomId;

      col.innerHTML = `
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h5 class="card-title mb-0">${roomId}</h5>
              <button class="btn btn-outline-danger btn-sm" data-delete>åˆªé™¤</button>
            </div>
            <div class="row g-2 mb-2">
              <div class="col-4">
                <label class="form-label mb-1">æ™‚</label>
                <input type="number" min="0" value="0" class="form-control form-control-sm" data-h />
              </div>
              <div class="col-4">
                <label class="form-label mb-1">åˆ†</label>
                <input type="number" min="0" value="0" class="form-control form-control-sm" data-m />
              </div>
              <div class="col-4">
                <label class="form-label mb-1">ç§’</label>
                <input type="number" min="0" value="30" class="form-control form-control-sm" data-s />
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2 mb-2">
              <button class="btn btn-success btn-sm" data-start>é–‹å§‹</button>
              <button class="btn btn-warning btn-sm" data-pause>æš«åœ</button>
              <button class="btn btn-secondary btn-sm" data-reset>é‡è¨­</button>
              <button class="btn btn-outline-primary btn-sm" data-open>é–‹å•Ÿé é¢</button>
            </div>
            <div class="status-text" data-status>ç‹€æ…‹ï¼šå°šæœªé€å‡º</div>
            <div class="status-text" data-current>ç›®å‰å€’æ•¸ï¼š--:--:--</div>
          </div>
        </div>
      `;

      cardsEl.appendChild(col);

      const hInput = col.querySelector('[data-h]');
      const mInput = col.querySelector('[data-m]');
      const sInput = col.querySelector('[data-s]');
      const statusEl = col.querySelector('[data-status]');
      const currentEl = col.querySelector('[data-current]');
      const startBtn = col.querySelector('[data-start]');
      const pauseBtn = col.querySelector('[data-pause]');
      const resetBtn = col.querySelector('[data-reset]');
      const openBtn = col.querySelector('[data-open]');
      const deleteBtn = col.querySelector('[data-delete]');

      startBtn.onclick = async () => {
        const h = Number(hInput.value) || 0;
        const m = Number(mInput.value) || 0;
        const s = Number(sInput.value) || 0;
        const totalSec = h * 3600 + m * 60 + s;
        const targetTime = Date.now() + totalSec * 1000;
        await sendApi({ room: roomId, action: 'start', targetTime }, statusEl);
      };

      pauseBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'pause' }, statusEl);
      };

      resetBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'reset' }, statusEl);
      };

      openBtn.onclick = () => {
        // é¡¯ç¤ºé ä¹Ÿè¦è¨˜å¾—æ”¹æˆæ‰“ Worker çš„ç‰ˆæœ¬å–”
        window.open(`/display.html?id=${encodeURIComponent(roomId)}`, '_blank');
      };

      deleteBtn.onclick = async () => {
        const ok = confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${roomId}ã€é€™å¼µå¡å—ï¼Ÿ`);
        if (!ok) return;
        const res = await sendApi({ room: roomId, action: 'delete' }, statusEl);
        if (res !== false) {
          col.remove();
          const cur = getSavedRooms();
          const next = cur.filter(r => r !== roomId && r !== CHECK_ROOM);
          saveRooms(next);
        }
      };

      // æ¯ç§’æ›´æ–°ç‹€æ…‹
      async function poll() {
        try {
          const res = await fetch(`${API_BASE}/api?room=${encodeURIComponent(roomId)}`);
          if (res.ok) {
            const data = await res.json();
            statusEl.textContent = 'ç‹€æ…‹ï¼š' + (data.state || 'æœªçŸ¥');
            let sec = null;
            if (data.state === 'paused' && typeof data.remaining === 'number') {
              sec = Math.floor(data.remaining / 1000);
            } else if (data.state === 'running' && data.targetTime) {
              sec = Math.max(0, Math.floor((data.targetTime - Date.now()) / 1000));
            }
            currentEl.textContent = 'ç›®å‰å€’æ•¸ï¼š' + (sec == null ? '--:--:--' : format(sec));
          }
        } catch (e) {
          // ignore
        } finally {
          setTimeout(poll, 1000);
        }
      }
      poll();
    }

    function format(sec) {
      const h = String(Math.floor(sec / 3600)).padStart(2, '0');
      const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    async function sendApi(body, statusEl) {
      try {
        const res = await fetch(`${API_BASE}/api`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...body, token: CONTROL_TOKEN })
        });
        if (res.status === 401) {
          overlay.style.display = '';
          controlUI.style.display = 'none';
          tokenError.style.display = 'block';
          return false;
        }
        if (!res.ok) {
          statusEl.textContent = 'ç‹€æ…‹ï¼šå¤±æ•— (' + res.status + ')';
          return false;
        }
        const data = await res.json();
        statusEl.textContent = 'ç‹€æ…‹ï¼šå·²é€å‡º ' + (data?.action || body.action);
        return true;
      } catch (err) {
        statusEl.textContent = 'ç‹€æ…‹ï¼šé€å‡ºå¤±æ•—';
        return false;
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
