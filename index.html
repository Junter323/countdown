<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>倒數控制中心</title>
  <!-- Bootstrap 5 CDN -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background: #f5f5f5;
    }
    .timer-card {
      min-width: 260px;
    }
    .status-text {
      font-size: 0.75rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-3">倒數控制中心</h1>

    <!-- 新增卡片列 -->
    <div class="row g-2 mb-4">
      <div class="col-auto">
        <input id="newId" type="text" class="form-control" placeholder="輸入倒數 ID，例如 show-1" />
      </div>
      <div class="col-auto">
        <button id="addBtn" class="btn btn-primary">新增倒數卡片</button>
      </div>
    </div>

    <!-- 卡片區塊 -->
    <div id="cards" class="row g-3">
      <!-- JS 會塞卡片進來 -->
    </div>
  </div>

  <script>
    const cardsEl = document.getElementById('cards');
    const addBtn = document.getElementById('addBtn');
    const newIdInput = document.getElementById('newId');

    addBtn.onclick = () => {
      const id = newIdInput.value.trim();
      if (!id) return;
      createCard(id);
      newIdInput.value = '';
    };

    // 先給一張預設
    createCard('show-1');

    function createCard(roomId) {
      // 不要重複建立
      if (document.getElementById('card-' + roomId)) return;

      const col = document.createElement('div');
      col.className = 'col-md-4 col-sm-6';
      col.id = 'card-' + roomId;

      col.innerHTML = `
        <div class="card shadow-sm timer-card">
          <div class="card-body">
            <h5 class="card-title mb-2">${roomId}</h5>
            <div class="mb-2">
              <label class="form-label mb-1">倒數秒數</label>
              <input type="number" min="0" value="30" class="form-control form-control-sm" data-seconds />
            </div>
            <div class="d-flex flex-wrap gap-2 mb-2">
              <button class="btn btn-success btn-sm" data-start>開始</button>
              <button class="btn btn-warning btn-sm" data-pause>暫停</button>
              <button class="btn btn-secondary btn-sm" data-reset>重設</button>
              <button class="btn btn-outline-primary btn-sm" data-open>開啟頁面</button>
            </div>
            <div class="status-text" data-status>狀態：尚未送出</div>
          </div>
        </div>
      `;

      cardsEl.appendChild(col);

      const secInput = col.querySelector('[data-seconds]');
      const statusEl = col.querySelector('[data-status]');
      const startBtn = col.querySelector('[data-start]');
      const pauseBtn = col.querySelector('[data-pause]');
      const resetBtn = col.querySelector('[data-reset]');
      const openBtn = col.querySelector('[data-open]');

      startBtn.onclick = async () => {
        const sec = Number(secInput.value);
        const targetTime = Date.now() + sec * 1000;
        await sendApi({ room: roomId, action: 'start', targetTime }, statusEl);
      };
      pauseBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'pause' }, statusEl);
      };
      resetBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'reset' }, statusEl);
      };
      openBtn.onclick = () => {
  	window.open(`/display.html?id=${encodeURIComponent(roomId)}`, '_blank');
      };
    }

    async function sendApi(body, statusEl) {
      try {
        const res = await fetch('/api', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          statusEl.textContent = '狀態：失敗 (' + res.status + ')';
          return;
        }
        const data = await res.json();
        const action = data?.received?.action || '';
        statusEl.textContent = '狀態：已送出 ' + action;
      } catch (err) {
        statusEl.textContent = '狀態：送出失敗';
      }
    }
  </script>

  <!-- Bootstrap JS (如果你之後要用 modal 等等可以留) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
