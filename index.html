<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Countdown Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #111;
      color: #fff;
    }
    .container {
      max-width: 700px;
      margin: auto;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      font-weight: 700;
    }
    input, button {
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 6px;
      border: none;
    }
    input[type=text], input[type=password], input[type=number] {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    button {
      cursor: pointer;
      background: #007aff;
      color: #fff;
      font-weight: 600;
      margin-right: 0.5rem;
    }
    button.delete {
      background: #c00;
    }
    button.small {
      font-size: 0.9rem;
      padding: 0.3rem 0.6rem;
    }
    .card {
      background: #222;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .card h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
    }
    .flex {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .status {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    @media (max-width: 600px) {
      .flex {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Countdown 控制台</h1>

    <div id="loginBox">
      <input id="tokenInput" type="password" placeholder="請輸入控制用 Token (例如 MOPCON2025)" />
      <button id="loginBtn">登入</button>
      <div id="loginMsg"></div>
    </div>

    <div id="controlBox" style="display:none">
      <div class="flex">
        <input id="newRoomName" type="text" placeholder="新房間名稱 (例如 r1)" />
        <button id="addRoomBtn">新增</button>
      </div>
      <hr />
      <div id="roomList"></div>
    </div>
  </div>

  <script>
    // 這裡換成你的 Worker 網址
    const API_BASE = "https://countdown-api.cometw1234.workers.dev";
    let CONTROL_TOKEN = "";

    const loginBox = document.getElementById("loginBox");
    const controlBox = document.getElementById("controlBox");
    const tokenInput = document.getElementById("tokenInput");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");
    const newRoomName = document.getElementById("newRoomName");
    const addRoomBtn = document.getElementById("addRoomBtn");
    const roomList = document.getElementById("roomList");

    async function sendApi(payload, statusEl) {
      try {
        const res = await fetch(`${API_BASE}/api`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || res.status);
        }
        statusEl.textContent = "✅ 成功";
        setTimeout(() => (statusEl.textContent = ""), 1500);
      } catch (e) {
        statusEl.textContent = "❌ " + e.message;
        setTimeout(() => (statusEl.textContent = ""), 2500);
      }
    }

    async function refreshRooms() {
      roomList.innerHTML = "<p>載入中...</p>";
      const res = await fetch(`${API_BASE}/api?rooms=1`);
      const data = await res.json();
      roomList.innerHTML = "";
      for (const room of data.rooms) {
        addRoomCard(room);
      }
    }

    function addRoomCard(roomId) {
      const card = document.createElement("div");
      card.className = "card";

      const title = document.createElement("h2");
      title.textContent = roomId;

      const hInput = document.createElement("input");
      hInput.type = "number";
      hInput.placeholder = "時";
      hInput.style.width = "5rem";

      const mInput = document.createElement("input");
      mInput.type = "number";
      mInput.placeholder = "分";
      mInput.style.width = "5rem";

      const sInput = document.createElement("input");
      sInput.type = "number";
      sInput.placeholder = "秒";
      sInput.style.width = "5rem";

      const startBtn = document.createElement("button");
      startBtn.textContent = "開始";

      const pauseBtn = document.createElement("button");
      pauseBtn.textContent = "暫停";

      const resetBtn = document.createElement("button");
      resetBtn.textContent = "重設";

      const delBtn = document.createElement("button");
      delBtn.textContent = "刪除";
      delBtn.className = "delete";

      const statusEl = document.createElement("span");
      statusEl.className = "status";

      const displayLink = document.createElement("a");
      displayLink.href = `display.html?id=${encodeURIComponent(roomId)}`;
      displayLink.textContent = "顯示畫面";
      displayLink.target = "_blank";
      displayLink.style.color = "#0bf";
      displayLink.style.textDecoration = "none";

      startBtn.onclick = async () => {
        const h = Number(hInput.value) || 0;
        const m = Number(mInput.value) || 0;
        const s = Number(sInput.value) || 0;
        const totalSec = h * 3600 + m * 60 + s;
        await sendApi({ room: roomId, action: "start", seconds: totalSec, token: CONTROL_TOKEN }, statusEl);
      };

      pauseBtn.onclick = async () => {
        await sendApi({ room: roomId, action: "pause", token: CONTROL_TOKEN }, statusEl);
      };

      resetBtn.onclick = async () => {
        await sendApi({ room: roomId, action: "reset", token: CONTROL_TOKEN }, statusEl);
      };

      delBtn.onclick = async () => {
        if (confirm(`確定刪除 ${roomId}？`)) {
          await sendApi({ room: roomId, action: "delete", token: CONTROL_TOKEN }, statusEl);
          card.remove();
        }
      };

      const flex1 = document.createElement("div");
      flex1.className = "flex";
      flex1.append(hInput, mInput, sInput);

      const flex2 = document.createElement("div");
      flex2.className = "flex";
      flex2.append(startBtn, pauseBtn, resetBtn, delBtn, displayLink, statusEl);

      card.append(title, flex1, flex2);
      roomList.append(card);
    }

    loginBtn.onclick = async () => {
      const token = tokenInput.value.trim();
      if (!token) {
        loginMsg.textContent = "請輸入 Token";
        return;
      }
      loginMsg.textContent = "驗證中...";
      const res = await fetch(`${API_BASE}/api`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ room: "__check__", action: "test", token }),
      });
      if (res.ok) {
        CONTROL_TOKEN = token;
        loginMsg.textContent = "✅ 登入成功";
        loginBox.style.display = "none";
        controlBox.style.display = "block";
        await refreshRooms();
      } else {
        loginMsg.textContent = "❌ Token 錯誤";
      }
    };

    addRoomBtn.onclick = async () => {
      const name = newRoomName.value.trim();
      if (!name) return;
      if ([...document.querySelectorAll(".card h2")].some((el) => el.textContent === name)) return;
      addRoomCard(name);
      newRoomName.value = "";
    };
  </script>
</body>
</html>
