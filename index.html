<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>倒數控制中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body { background: #f5f5f5; }
    .status-text { font-size: 0.75rem; color: #6c757d; }
    /* token 遮罩 */
    #token-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #token-box {
      background: #fff;
      padding: 20px 24px;
      border-radius: 8px;
      width: min(340px, 90vw);
      box-shadow: 0 4px 16px rgba(0,0,0,.2);
    }
    /* 卡片在手機時滿版 */
    @media (max-width: 576px) {
      .control-header {
        flex-direction: column;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- 一開始的 token 輸入畫面 -->
  <div id="token-overlay">
    <div id="token-box">
      <h5 class="mb-3">請輸入控制 token</h5>
      <input id="token-input" type="password" class="form-control mb-3" placeholder="請輸入 token" />
      <div class="d-grid gap-2">
        <button id="token-submit" class="btn btn-primary">進入控制台</button>
      </div>
      <div id="token-error" class="text-danger mt-2" style="display:none;">token 無效，請再試一次</div>
    </div>
  </div>

  <!-- 真正的控制頁面 -->
  <div class="container py-4" id="control-ui" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3 gap-2 control-header">
      <h1 class="mb-0">倒數控制中心</h1>
      <div class="d-flex gap-2 flex-wrap">
        <input id="newId" type="text" class="form-control" style="min-width:180px" placeholder="輸入倒數 ID，例如 show-1" />
        <button id="addBtn" class="btn btn-primary">新增倒數卡片</button>
      </div>
    </div>

    <div id="cards" class="row g-3">
      <!-- 卡片會動態插入 -->
    </div>
  </div>

  <script>
    // DOM 取得
    const cardsEl = document.getElementById('cards');
    const addBtn = document.getElementById('addBtn');
    const newIdInput = document.getElementById('newId');

    const overlay = document.getElementById('token-overlay');
    const controlUI = document.getElementById('control-ui');
    const tokenInput = document.getElementById('token-input');
    const tokenSubmit = document.getElementById('token-submit');
    const tokenError = document.getElementById('token-error');

    // 用來帶去後端的 token，先看 sessionStorage 有沒有
    let CONTROL_TOKEN = sessionStorage.getItem('countdown_token') || '';

    // 本機儲存卡片列表的 key
    const SAVED_KEY = 'countdown_rooms';
    function getSavedRooms() {
      try {
        return JSON.parse(localStorage.getItem(SAVED_KEY)) || [];
      } catch (e) {
        return [];
      }
    }
    function saveRooms(list) {
      localStorage.setItem(SAVED_KEY, JSON.stringify(list));
    }

    // 嘗試登入，成功才會看到控制頁
    async function tryEnter() {
      const t = tokenInput.value.trim();
      if (!t) return;

      // 用假 room 去後端驗證 token
      const res = await fetch('/api', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ room: '__check__', action: 'reset', token: t })
      });
      if (res.status === 401) {
        tokenError.style.display = 'block';
        return;
      }

      // 成功
      CONTROL_TOKEN = t;
      sessionStorage.setItem('countdown_token', t);
      overlay.style.display = 'none';
      controlUI.style.display = '';

      // 向後端拿目前有哪些房間
      let serverRooms = [];
      try {
        const res2 = await fetch('/api?rooms=1');
        if (res2.ok) {
          const data = await res2.json();
          serverRooms = data.rooms || [];
        }
      } catch (e) {
        // ignore
      }

      // 再加上本機存的
      const localRooms = getSavedRooms();
      const allRooms = Array.from(new Set([...serverRooms, ...localRooms]));
      if (allRooms.length === 0) {
        // 沒有任何房間就給預設
        createCard('show-1');
        saveRooms(['show-1']);
      } else {
        allRooms.forEach(r => createCard(r));
        saveRooms(allRooms);
      }
    }

    tokenSubmit.onclick = tryEnter;
    tokenInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') tryEnter();
    });

    // 如果這台瀏覽器之前已經成功過，就自動試一次
    (async () => {
      if (CONTROL_TOKEN) {
        tokenInput.value = CONTROL_TOKEN;
        await tryEnter();
      }
    })();

    // 新增卡片按鈕
    if (addBtn) {
      addBtn.onclick = () => {
        const id = newIdInput.value.trim();
        if (!id) return;
        createCard(id);
        // 存本機
        const cur = getSavedRooms();
        if (!cur.includes(id)) {
          cur.push(id);
          saveRooms(cur);
        }
        newIdInput.value = '';
      };
    }

    // 建立一張倒數卡片
    function createCard(roomId) {
      // 避免重複
      if (document.getElementById('card-' + roomId)) return;

      // col-12 手機滿版，md 以上兩欄，lg 三欄
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6 col-lg-4';
      col.id = 'card-' + roomId;

      col.innerHTML = `
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h5 class="card-title mb-0">${roomId}</h5>
              <button class="btn btn-outline-danger btn-sm" data-delete>刪除</button>
            </div>
            <div class="row g-2 mb-2">
              <div class="col-4">
                <label class="form-label mb-1">時</label>
                <input type="number" min="0" value="0" class="form-control form-control-sm" data-h />
              </div>
              <div class="col-4">
                <label class="form-label mb-1">分</label>
                <input type="number" min="0" value="0" class="form-control form-control-sm" data-m />
              </div>
              <div class="col-4">
                <label class="form-label mb-1">秒</label>
                <input type="number" min="0" value="30" class="form-control form-control-sm" data-s />
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2 mb-2">
              <button class="btn btn-success btn-sm" data-start>開始</button>
              <button class="btn btn-warning btn-sm" data-pause>暫停</button>
              <button class="btn btn-secondary btn-sm" data-reset>重設</button>
              <button class="btn btn-outline-primary btn-sm" data-open>開啟頁面</button>
            </div>
            <div class="status-text" data-status>狀態：尚未送出</div>
            <div class="status-text" data-current>目前倒數：--:--:--</div>
          </div>
        </div>
      `;

      cardsEl.appendChild(col);

      const hInput = col.querySelector('[data-h]');
      const mInput = col.querySelector('[data-m]');
      const sInput = col.querySelector('[data-s]');
      const statusEl = col.querySelector('[data-status]');
      const currentEl = col.querySelector('[data-current]');
      const startBtn = col.querySelector('[data-start]');
      const pauseBtn = col.querySelector('[data-pause]');
      const resetBtn = col.querySelector('[data-reset]');
      const openBtn = col.querySelector('[data-open]');
      const deleteBtn = col.querySelector('[data-delete]');

      // 開始
      startBtn.onclick = async () => {
        const h = Number(hInput.value) || 0;
        const m = Number(mInput.value) || 0;
        const s = Number(sInput.value) || 0;
        const totalSec = h * 3600 + m * 60 + s;
        const targetTime = Date.now() + totalSec * 1000;
        await sendApi({ room: roomId, action: 'start', targetTime }, statusEl);
      };

      // 暫停
      pauseBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'pause' }, statusEl);
      };

      // 重設
      resetBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'reset' }, statusEl);
      };

      // 開顯示頁
      openBtn.onclick = () => {
        window.open(`/display.html?id=${encodeURIComponent(roomId)}`, '_blank');
      };

      // 刪除
      deleteBtn.onclick = async () => {
        const ok = confirm(`確定要刪除「${roomId}」這張卡嗎？`);
        if (!ok) return;
        const res = await sendApi({ room: roomId, action: 'delete' }, statusEl);
        if (res !== false) {
          // 前端移除
          col.remove();
          // 本機存的也移除
          const cur = getSavedRooms();
          const next = cur.filter(r => r !== roomId);
          saveRooms(next);
        }
      };

      // 每秒抓一次狀態，顯示目前倒數
      async function poll() {
        try {
          const res = await fetch(`/api?room=${encodeURIComponent(roomId)}`);
          if (res.ok) {
            const data = await res.json();
            statusEl.textContent = '狀態：' + (data.state || '未知');

            let sec = null;
            if (data.state === 'paused' && typeof data.remaining === 'number') {
              sec = Math.floor(data.remaining / 1000);
            } else if (data.state === 'running' && data.targetTime) {
              sec = Math.max(0, Math.floor((data.targetTime - Date.now()) / 1000));
            }
            currentEl.textContent = '目前倒數：' + (sec == null ? '--:--:--' : format(sec));
          }
        } catch (e) {
          // ignore
        } finally {
          setTimeout(poll, 1000);
        }
      }
      poll();
    }

    function format(sec) {
      const h = String(Math.floor(sec / 3600)).padStart(2, '0');
      const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    async function sendApi(body, statusEl) {
      try {
        const res = await fetch('/api', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...body, token: CONTROL_TOKEN })
        });
        if (res.status === 401) {
          // token 錯，回登入
          overlay.style.display = '';
          controlUI.style.display = 'none';
          tokenError.style.display = 'block';
          return false;
        }
        if (!res.ok) {
          statusEl.textContent = '狀態：失敗 (' + res.status + ')';
          return false;
        }
        const data = await res.json();
        statusEl.textContent = '狀態：已送出 ' + (data?.action || body.action);
        return true;
      } catch (err) {
        statusEl.textContent = '狀態：送出失敗';
        return false;
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
