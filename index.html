<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>倒數控制中心</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body { background: #f5f5f5; }
    .timer-card { min-width: 260px; }
    .status-text { font-size: 0.75rem; color: #6c757d; }
    #token-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #token-box {
      background: #fff;
      padding: 20px 24px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 4px 16px rgba(0,0,0,.2);
    }
  </style>
</head>
<body>
  <div id="token-overlay">
    <div id="token-box">
      <h5 class="mb-3">請輸入控制 token</h5>
      <input id="token-input" type="password" class="form-control mb-3" placeholder="請輸入 token" />
      <div class="d-grid gap-2">
        <button id="token-submit" class="btn btn-primary">進入控制台</button>
      </div>
      <div id="token-error" class="text-danger mt-2" style="display:none;">token 無效，請再試一次</div>
    </div>
  </div>

  <div class="container py-4" id="control-ui" style="display:none;">
    <h1 class="mb-3">倒數控制中心</h1>

    <div class="row g-2 mb-4">
      <div class="col-auto">
        <input id="newId" type="text" class="form-control" placeholder="輸入倒數 ID，例如 show-1" />
      </div>
      <div class="col-auto">
        <button id="addBtn" class="btn btn-primary">新增倒數卡片</button>
      </div>
    </div>

    <div id="cards" class="row g-3"></div>
  </div>

  <script>
    const cardsEl = document.getElementById('cards');
    const addBtn = document.getElementById('addBtn');
    const newIdInput = document.getElementById('newId');

    const overlay = document.getElementById('token-overlay');
    const controlUI = document.getElementById('control-ui');
    const tokenInput = document.getElementById('token-input');
    const tokenSubmit = document.getElementById('token-submit');
    const tokenError = document.getElementById('token-error');

    let CONTROL_TOKEN = sessionStorage.getItem('countdown_token') || '';

    const SAVED_KEY = 'countdown_rooms';
    function getSavedRooms() {
      try {
        return JSON.parse(localStorage.getItem(SAVED_KEY)) || [];
      } catch (e) {
        return [];
      }
    }
    function saveRooms(list) {
      localStorage.setItem(SAVED_KEY, JSON.stringify(list));
    }

    async function tryEnter() {
      const t = tokenInput.value.trim();
      if (!t) return;

      // 先用假的 room 驗證 token
      const res = await fetch('/api', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ room: '__check__', action: 'reset', token: t })
      });
      if (res.status === 401) {
        tokenError.style.display = 'block';
        return;
      }

      CONTROL_TOKEN = t;
      sessionStorage.setItem('countdown_token', t);
      overlay.style.display = 'none';
      controlUI.style.display = '';

      // 1. 先跟後端拿有哪些 room
      let serverRooms = [];
      try {
        const res2 = await fetch('/api?rooms=1');
        if (res2.ok) {
          const data = await res2.json();
          serverRooms = data.rooms || [];
        }
      } catch (e) {
        // ignore
      }

      // 2. 再拿本機的
      const localRooms = getSavedRooms();

      // 3. 合併（去重）
      const allRooms = Array.from(new Set([...serverRooms, ...localRooms]));

      if (allRooms.length === 0) {
        // 沒東西就建一張預設
        createCard('show-1');
        saveRooms(['show-1']);
      } else {
        allRooms.forEach(r => createCard(r));
        // 同步回本機
        saveRooms(allRooms);
      }
    }

    tokenSubmit.onclick = tryEnter;
    tokenInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') tryEnter();
    });

    // 如果本機已經有 token，就先試著登入
    (async () => {
      if (CONTROL_TOKEN) {
        tokenInput.value = CONTROL_TOKEN;
        await tryEnter();
      }
    })();

    // 新增卡片
    if (addBtn) {
      addBtn.onclick = () => {
        const id = newIdInput.value.trim();
        if (!id) return;
        createCard(id);
        // 存本機
        const cur = getSavedRooms();
        if (!cur.includes(id)) {
          cur.push(id);
          saveRooms(cur);
        }
        newIdInput.value = '';
      };
    }

    function createCard(roomId) {
      if (document.getElementById('card-' + roomId)) return;

      const col = document.createElement('div');
      col.className = 'col-md-4 col-sm-6';
      col.id = 'card-' + roomId;

      col.innerHTML = `
        <div class="card shadow-sm timer-card">
          <div class="card-body">
            <h5 class="card-title mb-3">${roomId}</h5>
            <div class="row g-2 mb-2">
              <div class="col-4">
                <label class="form-label mb-1">時</label>
                <input type="number" min="0" value="0" class="form-control form-control-sm" data-h />
              </div>
              <div class="col-4">
                <label class="form-label mb-1">分</label>
                <input type="number" min="0" value="0" class="form-control form-control-sm" data-m />
              </div>
              <div class="col-4">
                <label class="form-label mb-1">秒</label>
                <input type="number" min="0" value="30" class="form-control form-control-sm" data-s />
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2 mb-2">
              <button class="btn btn-success btn-sm" data-start>開始</button>
              <button class="btn btn-warning btn-sm" data-pause>暫停</button>
              <button class="btn btn-secondary btn-sm" data-reset>重設</button>
              <button class="btn btn-outline-primary btn-sm" data-open>開啟頁面</button>
            </div>
            <div class="status-text" data-status>狀態：尚未送出</div>
            <div class="status-text" data-current>目前倒數：--:--:--</div>
          </div>
        </div>
      `;

      cardsEl.appendChild(col);

      const hInput = col.querySelector('[data-h]');
      const mInput = col.querySelector('[data-m]');
      const sInput = col.querySelector('[data-s]');
      const statusEl = col.querySelector('[data-status]');
      const currentEl = col.querySelector('[data-current]');
      const startBtn = col.querySelector('[data-start]');
      const pauseBtn = col.querySelector('[data-pause]');
      const resetBtn = col.querySelector('[data-reset]');
      const openBtn = col.querySelector('[data-open]');

      startBtn.onclick = async () => {
        const h = Number(hInput.value) || 0;
        const m = Number(mInput.value) || 0;
        const s = Number(sInput.value) || 0;
        const totalSec = h * 3600 + m * 60 + s;
        const targetTime = Date.now() + totalSec * 1000;
        await sendApi({ room: roomId, action: 'start', targetTime }, statusEl);
      };

      pauseBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'pause' }, statusEl);
      };

      resetBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'reset' }, statusEl);
      };

      openBtn.onclick = () => {
        window.open(`/display.html?id=${encodeURIComponent(roomId)}`, '_blank');
      };

      // 每秒去拿狀態
      async function poll() {
        try {
          const res = await fetch(`/api?room=${encodeURIComponent(roomId)}`);
          if (res.ok) {
            const data = await res.json();
            statusEl.textContent = '狀態：' + (data.state || '未知');
            let sec = null;
            if (data.state === 'paused' && typeof data.remaining === 'number') {
              sec = Math.floor(data.remaining / 1000);
            } else if (data.state === 'running' && data.targetTime) {
              sec = Math.max(0, Math.floor((data.targetTime - Date.now()) / 1000));
            }
            currentEl.textContent = '目前倒數：' + (sec == null ? '--:--:--' : format(sec));
          }
        } catch (e) {
          // ignore
        } finally {
          setTimeout(poll, 1000);
        }
      }
      poll();
    }

    function format(sec) {
      const h = String(Math.floor(sec / 3600)).padStart(2, '0');
      const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    async function sendApi(body, statusEl) {
      try {
        const res = await fetch('/api', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...body, token: CONTROL_TOKEN })
        });
        if (res.status === 401) {
          overlay.style.display = '';
          controlUI.style.display = 'none';
          tokenError.style.display = 'block';
          return;
        }
        if (!res.ok) {
          statusEl.textContent = '狀態：失敗 (' + res.status + ')';
          return;
        }
        const data = await res.json();
        statusEl.textContent = '狀態：已送出 ' + (data?.action || body.action);
      } catch (err) {
        statusEl.textContent = '狀態：送出失敗';
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
