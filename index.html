<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>倒數控制中心</title>
  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body { background: #f5f5f5; }
    .timer-card { min-width: 260px; }
    .status-text { font-size: 0.75rem; color: #6c757d; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-3">倒數控制中心</h1>

    <!-- token 區 -->
    <div class="mb-3 row g-2 align-items-center">
      <div class="col-auto">
        <label for="token" class="col-form-label">控制 token</label>
      </div>
      <div class="col-auto">
        <input id="token" type="password" class="form-control" placeholder="輸入控制用的 token" />
      </div>
      <div class="col-auto">
        <span class="text-muted" style="font-size:0.75rem;">（這個會一起送到 /api）</span>
      </div>
    </div>

    <!-- 新增卡片列 -->
    <div class="row g-2 mb-4">
      <div class="col-auto">
        <input id="newId" type="text" class="form-control" placeholder="輸入倒數 ID，例如 show-1" />
      </div>
      <div class="col-auto">
        <button id="addBtn" class="btn btn-primary">新增倒數卡片</button>
      </div>
    </div>

    <!-- 卡片區 -->
    <div id="cards" class="row g-3"></div>
  </div>

  <script>
    const cardsEl = document.getElementById('cards');
    const addBtn = document.getElementById('addBtn');
    const newIdInput = document.getElementById('newId');
    const tokenInput = document.getElementById('token');

    addBtn.onclick = () => {
      const id = newIdInput.value.trim();
      if (!id) return;
      createCard(id);
      newIdInput.value = '';
    };

    // 預設塞一張
    createCard('show-1');

    function createCard(roomId) {
      if (document.getElementById('card-' + roomId)) return;

      const col = document.createElement('div');
      col.className = 'col-md-4 col-sm-6';
      col.id = 'card-' + roomId;

      col.innerHTML = `
        <div class="card shadow-sm timer-card">
          <div class="card-body">
            <h5 class="card-title mb-3">${roomId}</h5>
            <div class="row g-2 mb-2">
              <div class="col-4">
                <label class="form-label mb-1">時</label>
                <input type="number" min="0" value="0" class="form-control form-control-sm" data-h />
              </div>
              <div class="col-4">
                <label class="form-label mb-1">分</label>
                <input type="number" min="0" value="0" class="form-control form-control-sm" data-m />
              </div>
              <div class="col-4">
                <label class="form-label mb-1">秒</label>
                <input type="number" min="0" value="30" class="form-control form-control-sm" data-s />
              </div>
            </div>
            <div class="d-flex flex-wrap gap-2 mb-2">
              <button class="btn btn-success btn-sm" data-start>開始</button>
              <button class="btn btn-warning btn-sm" data-pause>暫停</button>
              <button class="btn btn-secondary btn-sm" data-reset>重設</button>
              <button class="btn btn-outline-primary btn-sm" data-open>開啟頁面</button>
            </div>
            <div class="status-text" data-status>狀態：尚未送出</div>
            <div class="status-text" data-current>目前倒數：--:--:--</div>
          </div>
        </div>
      `;

      cardsEl.appendChild(col);

      const hInput = col.querySelector('[data-h]');
      const mInput = col.querySelector('[data-m]');
      const sInput = col.querySelector('[data-s]');
      const statusEl = col.querySelector('[data-status]');
      const currentEl = col.querySelector('[data-current]');
      const startBtn = col.querySelector('[data-start]');
      const pauseBtn = col.querySelector('[data-pause]');
      const resetBtn = col.querySelector('[data-reset]');
      const openBtn = col.querySelector('[data-open]');

      startBtn.onclick = async () => {
        const h = Number(hInput.value) || 0;
        const m = Number(mInput.value) || 0;
        const s = Number(sInput.value) || 0;
        const totalSec = h * 3600 + m * 60 + s;
        const targetTime = Date.now() + totalSec * 1000;
        await sendApi({ room: roomId, action: 'start', targetTime }, statusEl);
      };
      pauseBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'pause' }, statusEl);
      };
      resetBtn.onclick = async () => {
        await sendApi({ room: roomId, action: 'reset' }, statusEl);
      };
      openBtn.onclick = () => {
        window.open(`/display.html?id=${encodeURIComponent(roomId)}`, '_blank');
      };

      // 每秒抓一次狀態，顯示「目前倒數」
      async function poll() {
        try {
          const res = await fetch(`/api?room=${encodeURIComponent(roomId)}`);
          if (res.ok) {
            const data = await res.json();
            // 狀態同步一下
            statusEl.textContent = '狀態：' + (data.state || '未知');
            // 把剩餘時間轉成 00:00:00
            let sec = null;
            if (data.state === 'paused' && typeof data.remaining === 'number') {
              sec = Math.floor(data.remaining / 1000);
            } else if (data.state === 'running' && data.targetTime) {
              sec = Math.max(0, Math.floor((data.targetTime - Date.now()) / 1000));
            }
            currentEl.textContent = '目前倒數：' + (sec == null ? '--:--:--' : format(sec));
          }
        } catch (e) {
          // ignore
        } finally {
          setTimeout(poll, 1000);
        }
      }
      poll();
    }

    function format(sec) {
      const h = String(Math.floor(sec / 3600)).padStart(2, '0');
      const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    async function sendApi(body, statusEl) {
      try {
        const token = tokenInput.value.trim();
        const res = await fetch('/api', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ ...body, token })
        });
        if (!res.ok) {
          statusEl.textContent = '狀態：失敗 (' + res.status + ')';
          return;
        }
        const data = await res.json();
        statusEl.textContent = '狀態：已送出 ' + (data?.action || body.action);
      } catch (err) {
        statusEl.textContent = '狀態：送出失敗';
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
